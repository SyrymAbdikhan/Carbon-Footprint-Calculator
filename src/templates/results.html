{% extends "base.html" %}

{% block content %}
<div class="mx-auto max-w-4xl px-4">
    <div class="px-3 py-12 mb-4 bg-gray-700 text-white text-center mx-auto border rounded-lg">
        <h1 class="mb-4 text-2xl font-extrabold tracking-tight leading-none md:text-3xl lg:text-4xl">
            Your footprint is equal to
        </h1>
        <h1 class="text-3xl font-extrabold tracking-tight leading-none md:text-4xl lg:text-5xl">
            {% if data.total_co2 >= 1000 %}
                {{ (data.total_co2/1000)|round(1) }} tonnes
            {% else %}
                {{ data.total_co2|round(1) }} kilograms
            {% endif %}
        </h1>
    </div>

    <div class="mb-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="p-4 border rounded-lg bg-indigo-600">
            <h5 class="mb-2 text-2xl font-bold tracking-tight text-white">
                Energy Usage
            </h5>
            <p class="font-normal text-white">
                Your consumption is equal to 
                <span class="underline">
                {% if data.energy_co2 >= 1000 %}
                    {{ (data.energy_co2/1000)|round(1) }} tonnes
                {% else %}
                    {{ data.energy_co2|round(1) }} kilograms
                {% endif %}
                </span>
            </p>
        </div>
        <div class="p-4 border rounded-lg bg-orange-500">
            <h5 class="mb-2 text-2xl font-bold tracking-tight text-white">
                Waste
            </h5>
            <p class="font-normal text-white">
                Your consumption is equal to 
                <span class="underline">
                {% if data.waste_co2 >= 1000 %}
                    {{ (data.waste_co2/1000)|round(1) }} tonnes
                {% else %}
                    {{ data.waste_co2|round(1) }} kilograms
                {% endif %}
                </span>
            </p>
        </div>
        <div class="p-4 border rounded-lg bg-teal-600">
            <h5 class="mb-2 text-2xl font-bold tracking-tight text-white">
                Travel
            </h5>
            <p class="font-normal text-white">
                Your consumption is equal to 
                <span class="underline">
                {% if data.travel_co2 >= 1000 %}
                    {{ (data.travel_co2/1000)|round(1) }} tonnes
                {% else %}
                    {{ data.travel_co2|round(1) }} kilograms
                {% endif %}
                </span>
            </p>
        </div>
    </div>

    <div class="p-5 mb-4 max-w-4xl mx-auto border rounded-lg" id="donut">
        <div class="hidden" id="data" data-total="{{data.total_co2}}">
            <div data-title="Energy Usage" data-value="{{data.energy_co2}}"></div>
            <div data-title="Waste" data-value="{{data.waste_co2}}"></div>
            <div data-title="Travel" data-value="{{data.travel_co2}}"></div>
        </div>
    </div>

    <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-5 border rounded-lg">
            <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900">
                Form data
            </h5>
            <hr class="mb-2">
            <p class="mb-2 p-2 font-normal text-gray-900 bg-gray-50 border rounded-lg">
                Monthly electricity bill: <span class="float-right text-gray-600">€{{ data.elec_bill }}</span>
            </p>
            <p class="mb-2 p-2 font-normal text-gray-900 bg-gray-50 border rounded-lg">
                Monthly natural gas bill: <span class="float-right text-gray-600">€{{ data.gas_bill }}</span>
            </p>
            <p class="mb-2 p-2 font-normal text-gray-900 bg-gray-50 border rounded-lg">
                Monthly fuel bill: <span class="float-right text-gray-600">€{{ data.fuel_bill }}</span>
            </p>
            <p class="mb-2 p-2 font-normal text-gray-900 bg-gray-50 border rounded-lg">
                Monthly waste generation: <span class="float-right text-gray-600">{{ data.waste_kg }} kg</span>
            </p>
            <p class="mb-2 p-2 font-normal text-gray-900 bg-gray-50 border rounded-lg">
                Waste recycle percentage: <span class="float-right text-gray-600">{{ data.recycle_pct }}%</span>
            </p>
            <p class="mb-2 p-2 font-normal text-gray-900 bg-gray-50 border rounded-lg">
                Yearly travel kilometers: <span class="float-right text-gray-600">{{ data.km_traveled }} km</span>
            </p>
            <p class="p-2 font-normal text-gray-900 bg-gray-50 border rounded-lg">
                Fuel efficiency: <span class="float-right text-gray-600">{{ data.fuel_eff }} liters</span>
            </p>
        </div>
        <div class="p-5 border rounded-lg">
            <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900">
                Statistical data
            </h5>
            <hr class="mb-2">
            <div class="mb-4">
                <h5 class="mb-1 text-lg font-bold tracking-tight text-indigo-500">
                    Average energy usage: 
                    <span class="underline">
                        {% if averages['energy_co2'] >= 1000 %}
                            {{ (averages['energy_co2']/1000)|round(1) }} tonnes
                        {% else %}
                            {{ averages['energy_co2']|round(1) }} kilograms
                        {% endif %}
                    </span>
                </h5>
                <p class="font-normal">
                    {% set diff = ((data.energy_co2 - averages['energy_co2']) * 100 / averages['energy_co2'])|round(1) %}
                    {% if diff < 0 %}
                        (You are {{ -1*diff }}% below average)
                    {% else %}
                        (You are {{ diff }}% above average)
                    {% endif %}
                </p>
            </div>
            <div class="mb-4">
                <h5 class="mb-1 text-lg font-bold tracking-tight text-orange-500">
                    Average waste: 
                    <span class="underline">
                        {% if averages['waste_co2'] >= 1000 %}
                            {{ (averages['waste_co2']/1000)|round(1) }} tonnes
                        {% else %}
                            {{ averages['waste_co2']|round(1) }} kilograms
                        {% endif %}
                    </span>
                </h5>
                <p class="font-normal">
                    {% set diff = ((data.waste_co2 - averages['waste_co2']) * 100 / averages['waste_co2'])|round(1) %}
                    {% if diff < 0 %}
                        (You are {{ -1*diff }}% below average)
                    {% else %}
                        (You are {{ diff }}% above average)
                    {% endif %}
                </p>
            </div>
            <div class="mb-4">
                <h5 class="mb-1 text-lg font-bold tracking-tight text-teal-600">
                    Average travel: 
                    <span class="underline">
                        {% if averages['travel_co2'] >= 1000 %}
                            {{ (averages['travel_co2']/1000)|round(1) }} tonnes
                        {% else %}
                            {{ averages['travel_co2']|round(1) }} kilograms
                        {% endif %}
                    </span>
                </h5>
                <p class="font-normal">
                    {% set diff = ((data.travel_co2 - averages['travel_co2']) * 100 / averages['travel_co2'])|round(1) %}
                    {% if diff < 0 %}
                        (You are {{ -1*diff }}% below average)
                    {% else %}
                        (You are {{ diff }}% above average)
                    {% endif %}
                </p>
            </div>
            <div class="mb-4">
                <h5 class="mb-1 text-lg font-bold tracking-tight">
                    Total average: 
                    <span class="underline">
                        {% if averages['total_co2'] >= 1000 %}
                            {{ (averages['total_co2']/1000)|round(1) }} tonnes
                        {% else %}
                            {{ averages['total_co2']|round(1) }} kilograms
                        {% endif %}
                    </span>
                </h5>
                <p class="font-normal">
                    {% set diff = ((data.total_co2 - averages['total_co2']) * 100 / averages['total_co2'])|round(1) %}
                    {% if diff < 0 %}
                        (You are {{ -1*diff }}% below average)
                    {% else %}
                        (You are {{ diff }}% above average)
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="flex justify-between">
        <a href="{{ url_for('index') }}" class="border rounded-lg p-3 text-blue-600 bg-white hover:bg-gray-100">Homepage</a>
        <button class="border rounded-lg p-3 bg-blue-600 text-white hover:bg-blue-500" onClick="window.print()">Print this page</button>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.6.0/d3.min.js"></script>

<script>
    var total = parseFloat(document.querySelector('#data').getAttribute('data-total'));
    var data = [...document.querySelectorAll('#data>div')].map(div => {
        return {
            label: div.getAttribute('data-title'),
            value: parseFloat(div.getAttribute('data-value')) * 100 / total
        };
    });

    var width = 700,
        height = 450,
        radius = Math.min(width, height) / 2;

    var svg = d3.select("#donut")
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("class", "max-w-xl mx-auto")
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    svg.append("g")
        .attr("class", "slices");
    svg.append("g")
        .attr("class", "labels");
    svg.append("g")
        .attr("class", "lines");

    var pie = d3.pie()
        .sort(null)
        .value(function(d) {
            return d.value;
        });

    var arc = d3.arc()
        .outerRadius(radius * 0.8)
        .innerRadius(radius * 0.4);

    var outerArc = d3.arc()
        .innerRadius(radius * 0.9)
        .outerRadius(radius * 0.9);

    var color = d3.scaleOrdinal()
        .range(["#6875f5", "#ff5b1f", "#0695a2"]);
    
    var key = function(d){ return d.data.label; };

    function midAngle(d){
        return d.startAngle + (d.endAngle - d.startAngle)/2;
    }

    /* ------- PIE SLICES ------- */
    var slice = svg.select(".slices").selectAll("path.slice")
        .data(pie(data), key)
        .enter()
        .insert("path")
        .style("fill", function(d) { return color(d.data.label); })
        .attr("class", "slice")
        .attr("d", arc);

    slice.exit().remove();

    /* ------- TEXT LABELS ------- */
    var text = svg.select(".labels").selectAll("text")
        .data(pie(data), key)
        .enter()
        .append("text")
        .style("text-anchor", function(d){
            return midAngle(d) < Math.PI ? "start":"end";
        });
    
    text.append("tspan")
        .attr("x", "0")
        .attr("dy", "-0.3em")
        .attr("font-weight", "bold")
        .attr("font-size", "120%")
        .text(function(d) {
            return d.data.label;
        });
    text.append("tspan")
        .attr("x", "0")
        .attr("dy", "1.2em")
        .text(function(d) {
            return d.data.value.toFixed(2) + " %";
        });
    
    text.attr("transform", function(d) {
        var pos = outerArc.centroid(d);
        pos[0] = radius * 0.95 * (midAngle(d) < Math.PI ? 1 : -1);
        return "translate("+ pos +")";
    })

    /* ------- SLICE TO TEXT POLYLINES ------- */
    var polyline = svg.select(".lines").selectAll("polyline")
        .data(pie(data), key)
        .enter()
        .append("polyline")
        .attr("style", "opacity: .3; stroke: black; stroke-width: 2px; fill: none;")
        .attr("points", function(d){
            var pos = outerArc.centroid(d);
            pos[0] = radius * 0.9 * (midAngle(d) < Math.PI ? 1 : -1);
            return [arc.centroid(d), outerArc.centroid(d), pos];
        });
</script>
{% endblock %}
