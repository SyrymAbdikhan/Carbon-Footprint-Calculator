{% extends "base.html" %}

{% block content %}
<div class="px-4 mx-auto">    
    <section class="bg-center bg-no-repeat  rounded-lg bg-gray-700 bg-blend-multiply">
        <div class="px-4 mx-auto max-w-screen-xl text-center py-24 lg:py-56">
            <h1 class="mb-4 text-3xl font-extrabold tracking-tight leading-none text-white md:text-4xl lg:text-5xl">Your footprint is equal to</h1>
            <h1 class="mb-4 text-4xl font-extrabold tracking-tight leading-none text-white md:text-5xl lg:text-6xl">{{ (data['Total']/1000)|round(1) }} tonnes</h1>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 py-6 gap-6">
        <div class="flex items-center bg-white border border-gray-200 rounded-lg shadow md:flex-row dark:border-gray-700 dark:bg-gray-800">
            <div class="object-cover w-48 h-auto bg-indigo-500 p-8 rounded-none rounded-s-lg">
                <svg fill="#fff" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 8h-4.3L18 2.5A1 1 0 0 0 17 1h-7a1 1 0 0 0-.9.6l-5 10A1 1 0 0 0 5 13h4.7L7 21.7a1 1 0 0 0 1.8 1l11-13A1 1 0 0 0 19 8Zm-8.7 9.7 1.7-5.4a1 1 0 0 0-1-1.3H6.6l4-8h4.7L12 8.5a1 1 0 0 0 1 1.5h3.8Z"/>
                </svg>
            </div>
            <div class="flex flex-col justify-between p-4 leading-normal">
                <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Energy Usage</h5>
                <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">Your consumption is equal to {{ (data['Energy Usage']/1000)|round(1) }} tonnes</p>
            </div>
        </div>
        <div class="flex items-center bg-white border border-gray-200 rounded-lg shadow md:flex-row dark:border-gray-700 dark:bg-gray-800">
            <div class="object-cover w-48 h-auto bg-teal-500 p-8 rounded-none rounded-s-lg">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g fill="#fff">
                        <path d="M12 2.8c-1 0-1.8.6-2.1 1.4a.8.8 0 0 1-1.4-.4 3.8 3.8 0 0 1 7 0 .8.8 0 0 1-1.4.4A2.3 2.3 0 0 0 12 2.7ZM2.8 6c0-.4.3-.8.7-.8h17a.8.8 0 0 1 0 1.5h-17a.8.8 0 0 1-.8-.7ZM6 8.5a.7.7 0 1 0-1.6 0l.5 7c0 1.3.1 2.3.3 3.1.2.9.5 1.6 1 2.1.6.6 1.4.8 2.2 1h7.2c.8-.2 1.6-.4 2.2-1 .5-.5.8-1.2 1-2 .2-.9.2-2 .3-3.2l.5-7a.8.8 0 0 0-1.5 0l-.5 6.8a26 26 0 0 1-.3 3c-.1.7-.3 1-.6 1.3-.2.3-.6.5-1.3.6h-3.8a26 26 0 0 1-3 0c-.7-.1-1-.3-1.3-.6-.3-.2-.5-.6-.6-1.3a26 26 0 0 1-.3-3l-.5-6.8Z"/>
                        <path d="M9.4 10.3c.4 0 .8.2.8.6l.5 5a.8.8 0 0 1-1.4.2l-.5-5c0-.4.2-.8.6-.8Zm5.8.7a.8.8 0 0 0-1.4 0l-.5 5a.8.8 0 0 0 1.4 0l.5-5Z"/>
                    </g>
                </svg>
            </div>
            <div class="flex flex-col justify-between p-4 leading-normal">
                <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Waste</h5>
                <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">Your consumption is equal to {{ (data['Waste']/1000)|round(1) }} tonnes</p>
            </div>
        </div>
        <div class="flex items-center bg-white border border-gray-200 rounded-lg shadow md:flex-row dark:border-gray-700 dark:bg-gray-800">
            <div class="object-cover w-48 h-auto bg-orange-500 p-8 rounded-none rounded-s-lg">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M6.8 6.8a1 1 0 0 1 1-.8h8.4c.5 0 1 .3 1 .8l.5 2.2H6.3l.5-2.2ZM2 11h1a5 5 0 0 0-1 3v1a3 3 0 0 0 2 2.8V20c0 .6.4 1 1 1h1c.6 0 1-.4 1-1v-2h10v2c0 .6.4 1 1 1h1c.6 0 1-.4 1-1v-2.2a3 3 0 0 0 2-2.8v-1a5 5 0 0 0-1-3h1a1 1 0 1 0 0-2h-1a1 1 0 0 0-1 .9v-.1l-.8-3.5a3 3 0 0 0-3-2.3H7.8a3 3 0 0 0-3 2.3L4 9.8v.1A1 1 0 0 0 3 9H2a1 1 0 0 0 0 2Zm5 0a3 3 0 0 0-3 3v1c0 .6.4 1 1 1h14c.6 0 1-.4 1-1v-1a3 3 0 0 0-3-3H7Zm-1 2.5a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM16.5 12a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z" fill="#fff"/>
                </svg>
            </div>
            <div class="flex flex-col justify-between p-4 leading-normal">
                <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Travel</h5>
                <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">Your consumption is equal to {{ (data['Travel']/1000)|round(1) }} tonnes</p>
            </div>
        </div>
    </div>
        
    <div id="donut" class="my-4">
        <div class="hidden" id="data" data-total="{{data['Total']}}">
            {% for key, value in data.items() if key != "Total" %}
            <div data-title="{{key}}" data-value="{{value}}"></div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.6.0/d3.min.js"></script>

<script>
    var total = parseFloat(document.querySelector('#data').getAttribute('data-total'));
    var data = [...document.querySelectorAll('#data>div')].map(div => {
        return {
            label: div.getAttribute('data-title'),
            value: parseFloat(div.getAttribute('data-value')) * 100 / total
        };
    });

    var width = 700,
        height = 450,
        radius = Math.min(width, height) / 2;

    var svg = d3.select("#donut")
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("class", "max-w-2xl mx-auto")
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    svg.append("g")
        .attr("class", "slices");
    svg.append("g")
        .attr("class", "labels");
    svg.append("g")
        .attr("class", "lines");

    var pie = d3.pie()
        .sort(null)
        .value(function(d) {
            return d.value;
        });

    var arc = d3.arc()
        .outerRadius(radius * 0.8)
        .innerRadius(radius * 0.4);

    var outerArc = d3.arc()
        .innerRadius(radius * 0.9)
        .outerRadius(radius * 0.9);

    var color = d3.scaleOrdinal()
        .range(["#6875f5", "#ff5b1f", "#0695a2"]);
    
    var key = function(d){ return d.data.label; };

    function midAngle(d){
        return d.startAngle + (d.endAngle - d.startAngle)/2;
    }

    /* ------- PIE SLICES ------- */
    var slice = svg.select(".slices").selectAll("path.slice")
        .data(pie(data), key)
        .enter()
        .insert("path")
        .style("fill", function(d) { return color(d.data.label); })
        .attr("class", "slice")
        .attr("d", arc);

    slice.exit().remove();

    /* ------- TEXT LABELS ------- */
    var text = svg.select(".labels").selectAll("text")
        .data(pie(data), key)
        .enter()
        .append("text")
        .style("text-anchor", function(d){
            return midAngle(d) < Math.PI ? "start":"end";
        });
    
    text.append("tspan")
        .attr("x", "0")
        .attr("dy", "-0.3em")
        .attr("font-weight", "bold")
        .attr("font-size", "120%")
        .text(function(d) {
            return d.data.label;
        });
    text.append("tspan")
        .attr("x", "0")
        .attr("dy", "1.2em")
        .text(function(d) {
            return d.data.value.toFixed(2) + " %";
        });
    
    text.attr("transform", function(d) {
        var pos = outerArc.centroid(d);
        pos[0] = radius * 0.95 * (midAngle(d) < Math.PI ? 1 : -1);
        return "translate("+ pos +")";
    })

    /* ------- SLICE TO TEXT POLYLINES ------- */
    var polyline = svg.select(".lines").selectAll("polyline")
        .data(pie(data), key)
        .enter()
        .append("polyline")
        .attr("style", "opacity: .3; stroke: black; stroke-width: 2px; fill: none;")
        .attr("points", function(d){
            var pos = outerArc.centroid(d);
            pos[0] = radius * 0.9 * (midAngle(d) < Math.PI ? 1 : -1);
            return [arc.centroid(d), outerArc.centroid(d), pos];
        });
</script>
{% endblock %}
